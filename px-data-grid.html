<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-grid/vaadin-grid.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="px-data-grid-column.html">
<link rel="import" href="px-data-grid-theme.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html"/>

<dom-module id="px-data-grid">
  <template>

    <template is="dom-if" if="[[actionMenu]]" restamp>
        <px-dropdown
          display-value="[[localize('Table Actions')]]"
        >
        </px-dropdown>
    </template>

    <vaadin-grid aria-label="Data Grid"
                 items="[[tableData]]"
                 size="[[size]]"
                 data-provider="[[dataProvider]]"
                 active-item="[[activeItem]]"
                 column-reordering-allowed="[[columnReorderingAllowed]]"
                 expanded-items="[[expandedItems]]"
                 theme="row-stripes"
                 selected-items="[[selectedItems]]"
                 multi-sort="[[multiSort]]">

      <template is="dom-if" if="[[selectable]]" restamp>
        <vaadin-grid-selection-column auto-select>
        </vaadin-grid-selection-column>
      </template>

      <template is="dom-repeat" items="[[_tableColumns]]" as="column">
        <px-data-grid-column>
          <template class="header">
            <vaadin-grid-sorter path="[[column]]">[[column]]</vaadin-grid-sorter>
          </template>
          <template>[[get(column, item)]]</template>
        </px-data-grid-column>
      </template>

      <slot></slot>
    </vaadin-grid>
  </template>
  <script>
    {
      class DataGridElement extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {

        static get is() {
          return 'px-data-grid';
        }

        static get properties() {
          return {

            /**
             * Data for the table to display.
             *
             * Expected data format is a JSON array of objects. Each object in the array represents a row in the table.
             *
             * Each item in an object will be displayed as a separate column, unless px-data-table-columns are
             * defined to limit which columns are displayed.
             */
            tableData: {
              type: Array,
              value: function() {
                return [];
              },
              observer: '_tableDataChanged',
              notify: true
            },

            /**
             * Use the selectable property if one or more rows within the table should be selectable. See also `singleSelect`.
             */
            selectable: {
              type: Boolean,
              value: false
            },

            /**
             * An array that contains the selected items.
             */
            selectedItems: {
              type: Object,
              value: undefined,
              notify: true
            },

            /**
             * The total number of items
             */
            size: {
              type: Number,
              value: undefined
            },

            /**
             * Function that provides items lazily. Receives arguments params, callback
             */
            dataProvider: {
              type: Object,
              value: undefined
            },

            /**
             * Number of items fetched at a time from the dataprovider.
             */
            pageSize: {
              type: Number,
              value: undefined
            },

            /**
             * When `true`, user can sort by multiple columns
             */
            multiSort: {
              type: Boolean,
              value: false
            },

            /**
             * The item user has last interacted with. Turns to `null` after user deactivates
             * the item by re-interacting with the currently active item.
             */
            activeItem: {
              type: Object,
              notify: true,
              value: null
            },

            /**
             * Set to true to allow column reordering.
             */
            columnReorderingAllowed: {
              type: Boolean,
              value: false
            },

            /**
            * An array containing references to expanded items.
            */
            expandedItems: {
              type: Array,
              value: []
            },

            /**
             * Define if table action menu is shown or not
             */
            actionMenu: {
              type: Boolean,
              value: false
            },

            /**
             * In case px-data-table-columns aren't provided, table columns will be generated automatically.
             * They will be stamped via
             *
             * <template is="dom-repeat" items="[[_tableColumns]]">
             *   ...
             * </template>
             *
             * @private
             */
            _tableColumns: {
              type: Array
            },

            /**
             * A valid IETF language tag as a string that `app-localize-behavior` will
             * use to localize this component.
             *
             * See https://github.com/PolymerElements/app-localize-behavior for API
             * documentation and more information.
             */
            language: {
              type: String,
              value: 'en'
            },

            /**
             * Use the key for localization if value for that language is missing.
             * Should always be true for Predix components.
             */
            useKeyIfMissing: {
              type: Boolean,
              value: true
            },

            /**
             * Library object of hardcoded strings used in this application.
             * Used by `app-localize-behavior` in conjunction with `language`.
             */
            resources: {
              type: Object,
              value: function() {
                // can also load these from external file as shown here:
                // https://www.polymer-project.org/2.0/toolbox/localize
                return {
                  'en': {
                    'Table Actions': 'Table Actions'
                  },
                  'fr': {
                    'Table Actions': 'Actions de la table'
                  },
                  'fi': {
                    'Table Actions': 'Taulukkotoiminnot'
                  }
                };
              }
            },
          };
        }

        ready() {
          super.ready();
          this._addColumnsObserver();
        }

        _tableDataChanged() {
          this._populateTableColumns();
        }

        _populateTableColumns() {
          if (this.tableData && this.tableData.length) {
            this._tableColumns = [];
            for (const key in this.tableData[0]) {
              this._tableColumns.push(key);
            }
          }
        }

        _addColumnsObserver() {
          this._observer = new Polymer.FlattenedNodesObserver(this, info => {
            const manualColumns = this.querySelectorAll(Predix.DataGridColumnElement.is);
            if (manualColumns.length) {
              this._tableColumns = [];
            } else {
              this._populateTableColumns();
            }
          });
        }
      }
      customElements.define(DataGridElement.is, DataGridElement);

      /**
       * @namespace Predix
       */
      window.Predix = window.Predix || {};
      Predix.DataGridElement = DataGridElement;
    }
  </script>
</dom-module>
