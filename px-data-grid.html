<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-grid/vaadin-grid.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="px-data-grid-column.html">
<link rel="import" href="px-data-grid-theme.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html"/>

<dom-module id="px-data-grid">
  <template>

    <template is="dom-if" if="[[actionMenu]]">
      <px-dropdown multi hide-selected
        display-value="[[localize('Table Actions')]]"
        items="[[_actionMenuContent]]"
        disable-clear
        on-px-dropdown-click="_actionClicked">
      </px-dropdown>
    </template>

    <vaadin-grid items="[[tableData]]"
                 size="[[size]]"
                 data-provider="[[remoteDataProvider]]"
                 active-item="[[activeItem]]"
                 column-reordering-allowed="[[columnReorderingAllowed]]"
                 expanded-items="[[expandedItems]]"
                 striped$="[[striped]]"
                 selected-items="[[selectedItems]]"
                 multi-sort="[[multiSort]]">

      <template is="dom-if" if="[[selectable]]" restamp>
        <vaadin-grid-selection-column auto-select>
        </vaadin-grid-selection-column>
      </template>

      <template is="dom-repeat" items="[[_generatedColumns]]" as="column">
        <px-data-grid-column resizable="[[resizable]]" name="[[column.name]]" hidden="[[column.hidden]]" language="[[language]]" resources="[[resources]]">
          <template class="header">
            <vaadin-grid-sorter path="[[column.name]]">[[column.name]]</vaadin-grid-sorter>
          </template>
          <template>[[get(column.name, item)]]</template>
        </px-data-grid-column>
      </template>

      <slot></slot>
    </vaadin-grid>
  </template>
  <script>
    {
      class DataGridElement extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {

        static get is() {
          return 'px-data-grid';
        }

        static get properties() {
          return {

            /**
             * Data for the table to display.
             *
             * Expected data format is a JSON array of objects. Each object in the array represents a row in the table.
             *
             * Each item in an object will be displayed as a separate column, unless px-data-table-columns are
             * defined to limit which columns are displayed.
             */
            tableData: {
              type: Array,
              value: function() {
                return [];
              },
              observer: '_tableDataChanged',
              notify: true
            },

            /**
             * Use the selectable property if one or more rows within the table should be selectable. See also `singleSelect`.
             */
            selectable: {
              type: Boolean,
              value: false
            },

            /**
             * An array that contains the selected items.
             */
            selectedItems: {
              type: Object,
              value: undefined,
              notify: true
            },

            /**
             * The total number of items
             */
            size: {
              type: Number,
              value: undefined
            },

            /**
             * Number of items fetched at a time from the dataprovider.
             */
            pageSize: {
              type: Number,
              value: undefined
            },

            /**
             * When `true`, user can sort by multiple columns
             */
            multiSort: {
              type: Boolean,
              value: false
            },

            /**
             * The item user has last interacted with. Turns to `null` after user deactivates
             * the item by re-interacting with the currently active item.
             */
            activeItem: {
              type: Object,
              notify: true,
              value: null
            },

            /**
             * When `true`, user can resize columns
             */
            resizable: {
              type: Boolean,
              value: false
            },

            /**
             * Set to true to allow column reordering.
             */
            columnReorderingAllowed: {
              type: Boolean,
              value: false
            },

            /**
            * An array containing references to expanded items.
            */
            expandedItems: {
              type: Array,
              value: []
            },

            /**
             * Define if table action menu is shown or not
             */
            actionMenu: {
              type: Boolean,
              value: false
            },

            /**
             * In case px-data-table-columns aren't provided, table columns will be generated automatically.
             * They will be stamped via
             *
             * <template is="dom-repeat" items="[[_generatedColumns]]">
             *   ...
             * </template>
             *
             * @private
             */
            _generatedColumns: {
              type: Array
            },

            /**
            * Content of action menu
            */
            _actionMenuContent: {
              type: Array
            },

            /**
             * A valid IETF language tag as a string that `app-localize-behavior` will
             * use to localize this component.
             *
             * See https://github.com/PolymerElements/app-localize-behavior for API
             * documentation and more information.
             */
            language: {
              type: String,
              value: 'en'
            },

            /**
             * Use the key for localization if value for that language is missing.
             * Should always be true for Predix components.
             */
            useKeyIfMissing: {
              type: Boolean,
              value: true
            },

            /**
             * Library object of hardcoded strings used in this application.
             * Used by `app-localize-behavior` in conjunction with `language`.
             */
            resources: {
              type: Object,
              value: function() {
                // can also load these from external file as shown here:
                // https://www.polymer-project.org/2.0/toolbox/localize
                return {
                  'en': {
                    'Table Actions': 'Table Actions',
                    'Freeze column': 'Freeze column',
                    'Unfreeze column': 'Unfreeze column',
                    'Hide column': 'Hide column'
                  },
                  'fr': {
                    'Table Actions': 'Actions de la table'
                  },
                  'fi': {
                    'Table Actions': 'Taulukkotoiminnot',
                    'Hide column': 'Piilota sarake'
                  }
                };
              }
            },

            /**
             * All custom table actions. Should return array of objects with 'name' (String) and 'action' (function).
             */
            tableActions: {
              type: Array,
              value: []
            },

            /**
             * Function that provides items lazily. Receives arguments params, callback
             */
            remoteDataProvider: {
              type: Function
            },

            /**
             * If true, every other row in the table will appear with a background color to improve visual scanning.
             */
            striped: {
              type: Boolean,
              value: false
            }
          };
        }

        ready() {
          super.ready();
          this._addColumnsObserver();
        }

        _tableDataChanged(tableData) {
          this._populateTableColumns(tableData);
        }

        _populateTableColumns(data) {
          const manualColumns = this.querySelectorAll(Predix.DataGridColumnElement.is);

          if (!manualColumns.length && data && data.length) {
            this._generatedColumns = [];
            for (const key in data[0]) {
              this._generatedColumns.push({
                'name': key,
                'hidden': false
              });
            }

            this._updateActionMenu();
          }
        }

        /**
         * Event handler for action menu clicks
         */
        _actionClicked(evt) {
          const item = evt.detail.detail.item;
          const key = item.key;

          if (key.action) {
            key.action();
          }
        }

        /**
         * Function to resolve columns on grid
         */
        _getColumns() {
          const gridElement = this.shadowRoot.querySelector('vaadin-grid');

          if (gridElement._columnTree) {
            return gridElement._columnTree[0];
          } else if (this._generatedColumns && this._generatedColumns.length) {
            return this._generatedColumns;
          } else {
            return [];
          }

        }

        /**
         * Function called when action menu content needs to be updated
         */
        _updateActionMenu() {
          const content = [];

          // Application specific options

          if (this.tableActions) {
            this.tableActions.forEach(function(item) {
              content.push({
                key: {
                  action: item.action
                },
                val: item.name,
                selected: false,
                disabled: true
              });
            });
          }

          // Add column hide/show selection

          const defaultName = this.localize('Column #');
          let counter = 0;

          this._getColumns().forEach(function(columnElement) {
            const index = ++counter;
            const hidden = columnElement.hidden ? columnElement.hidden : false;
            const name = columnElement.name ? columnElement.name : (defaultName + index);

            content.push({
              key: {
                action: function() {
                  columnElement.hidden = !(columnElement.hidden ? columnElement.hidden : false);
                }
              },
              val: name,
              selected: !hidden
            });
          });

          this._actionMenuContent = content;
        }

        /**
         * Observer for internal DOM changes
         */
        _addColumnsObserver() {
          this._observer = new Polymer.FlattenedNodesObserver(this, info => {
            const manualColumns = this.querySelectorAll(Predix.DataGridColumnElement.is);
            this._handleManualColumns(manualColumns);
          });
        }

        _handleManualColumns(manualColumns) {
          manualColumns.forEach((column) => {
            column.language = this.language;
            column.resources = this.resources;
          });

          if (manualColumns.length) {
            this._generatedColumns = [];
          } else {
            this._populateTableColumns();
          }
          this._updateActionMenu();
        }
      }
      customElements.define(DataGridElement.is, DataGridElement);

      /**
       * @namespace Predix
       */
      window.Predix = window.Predix || {};
      Predix.DataGridElement = DataGridElement;
    }
  </script>
</dom-module>
