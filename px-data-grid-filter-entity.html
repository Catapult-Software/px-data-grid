<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../px-datetime-picker/px-datetime-picker.html">
<link rel="import" href="../px-slider/px-slider.html">
<link rel="import" href="../px-rangepicker/px-rangepicker.html">
<link rel="import" href="css/px-data-grid-filter-entity-styles.html">

<dom-module id="px-data-grid-filter-entity">
  <template>
    <style include="px-data-grid-filter-entity-styles"></style>

    <div class="labeled-text">
      <label for="column-dropdown">
        [[localize('Attribute')]]
      </label>
      <px-dropdown id="column-dropdown" items="[[_mappedColumns]]" selected="{{entity.columnId}}"></px-dropdown>
    </div>

    <template is="dom-if" if="{{_columnTypeIsString(entity.columnId)}}">
      <div class="labeled-text">
        <label for="condition-dropdown">
          [[localize('Condition')]]
        </label>
        <px-dropdown id="condition-dropdown" items="[[_regexPatterns]]" selected="{{entity.pattern}}"></px-dropdown>
      </div>

      <div class="labeled-text">
        <label for="value-input">
          [[localize('Value')]]
        </label>
        <input id="value-input" type="text" class="text-input" value="{{entity.query::input}}">
      </div>
    </template>

    <template is="dom-if" if="{{_columnTypeIsDate(entity.columnId)}}">
      <div class="labeled-text" extended>
        <label for="date-rangepicker">
          [[localize('Date Range')]]
        </label>
        <px-rangepicker
          id="date-rangepicker"
          hide-time
          hide-presets
          show-buttons
          date-format="YYYY/MM/DD"
          time-format="HH:mm:ss"
          time-zone="UTC"
          show-time-zone="abbreviatedText"
          from-moment="{{_dateFrom}}"
          to-moment="{{_dateTo}}">
        </px-rangepicker>
      </div>
    </template>

    <template is="dom-if" if="{{_columnTypeIsNumber(entity.columnId)}}">
      <div class="labeled-text" extended>
        <label for="range-input">
          [[localize('Range')]]
        </label>
        <px-slider
          id="range-input"
          min="1"
          max="100"
          value="{{entity.leftBound}}"
          end-value="{{entity.rightBound}}"
          step="1"
          is-range>
        </px-slider>
      </div>
    </template>
  </template>
  <script>
    {
      /**
       * @memberof Predix
       * @extends Polymer.Element
       */
      class DataGridFilterEntityElement extends Polymer.Element {
        static get is() {
          return 'px-data-grid-filter-entity';
        }

        static get properties() {
          return {
            columns: Array,

            tableData: Array,

            entity: {
              type: Object
            },

            _mappedColumns: Array,

            _regexPatterns: {
              type: Array,
              value: [
                {
                  key: 'equals',
                  val: 'Equals'
                },
                {
                  key: 'contains',
                  val: 'Contains'
                },
                {
                  key: 'starts_with',
                  val: 'Starts With'
                },
                {
                  key: 'ends_with',
                  val: 'Ends With'
                },
                {
                  key: 'wildcard',
                  val: 'Wildcard'
                }
              ]
            },

            _dateFrom: {
              type: Object
            },

            _dateTo: {
              type: Object
            },

            _selectedColumnId: {
              type: String
            },

            localize: Function
          };
        }

        static get observers() {
          return [
            '_setMappedColumns(columns, columns.*)',
            '_filterActiveObservable(entity, entity.*)',
            '_momentDatesObserver(_dateFrom, _dateTo, _dateFrom.*, _dateTo.*)',
            '_entityDatesObserver(entity, entity.dateFrom, entity.dateTo)',
            '_selectedColumnChanged(_selectedColumnId)',
            '_localizeChanged(localize)'
          ];
        }

        _localizeChanged(localize) {
          if (!localize) {
            return;
          }

          this._regexPatterns.forEach((pattern, index) => {
            this.set(`_regexPatterns.${index}.val`, localize(pattern.val));
          });
        }

        _setMappedColumns(columns, columnsSplices) {
          if (!columns && !columnsSplices) {
            return;
          }

          this.set('_mappedColumns', []);

          columns.forEach((col) => {
            this.push('_mappedColumns', {key: col.id, val: col.path});
          });
        }

        _columnTypeIsString(columnId) {
          const column = this._getColumnById(columnId);

          return column && !['date', 'number'].includes(column.type);
        }

        _columnTypeIsDate(columnId) {
          const column = this._getColumnById(columnId);

          return column && column.type === 'date';
        }

        _columnTypeIsNumber(columnId) {
          const column = this._getColumnById(columnId);

          return column && column.type === 'number';
        }

        _getColumnById(columnId) {
          if (!this.columns) {
            return;
          }
          return this.columns.filter((column) => column.id === columnId)[0];
        }

        _filterActiveObservable(entity) {
          if (entity.columnId) {
            if (this._columnTypeIsString(entity.columnId)) {
              this.set('entity.active', !!entity.pattern && !!entity.query && !!entity.columnId);
            } else if (this._columnTypeIsDate(entity.columnId)) {
              this.set('entity.active', !!entity.columnId && (!!entity.dateFrom || !!entity.dateTo));
            } else if (this._columnTypeIsNumber(entity.columnId)) {
              this.set('entity.active', !!entity.columnId && (!!entity.leftBound || !!entity.rightBound));
            }
          }
        }

        _momentDatesObserver(dateFrom, dateTo) {
          if (dateFrom && window.moment(this.entity.dateFrom).format() !== dateFrom.format()) {
            this.set('entity.dateFrom', dateFrom.format());
          }
          if (dateTo && window.moment(this.entity.dateTo).format() !== dateTo.format()) {
            this.set('entity.dateTo', dateTo.format());
          }
        }

        _entityDatesObserver(entity) {
          if (entity.dateFrom && (!this._dateFrom || window.moment(this.entity.dateFrom).format() !== this._dateFrom.format())) {
            this.set('_dateFrom', window.moment(this.entity.dateFrom));
          }
          if (entity.dateTo && (!this._dateTo || window.moment(this.entity.dateTo).format() !== this._dateTo.format())) {
            this.set('_dateTo', window.moment(this.entity.dateTo));
          }
        }
      }

      customElements.define(DataGridFilterEntityElement.is, DataGridFilterEntityElement);

      /**
       * @namespace Predix
       */
      window.Predix = window.Predix || {};
      Predix.DataGridFilterEntityElement = DataGridFilterEntityElement;
    }
  </script>
</dom-module>
