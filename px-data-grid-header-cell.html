<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html"/>

<dom-module id="px-data-grid-header-cell">
  <template>
    <style>
      :host {
        display: flex;
        flex: 1;
        align-items: center;
        --iron-icon-fill-color: var(--px-data-grid-cell-text-color--sorted);
        --iron-icon-stroke-color: var(--px-data-grid-cell-text-color--sorted);
        justify-content: space-between;
      }

      px-dropdown[hidden] {
        visibility: hidden;
      }

      ::slotted(vaadin-grid-sorter) {
        align-items: center;
      }
    </style>
    <slot></slot>
    <px-dropdown button-style="icon" icon="px-nav:menu" items="{{_dropdownItems}}" opened="{{dropdownOpened}}" hidden="{{_dropdownHidden}}" on-selected-changed="_dropdownSelectedChanged"></px-dropdown>
  </template>
  <script>
    {
      class DataGridHeaderCellElement extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {
        static get is() {
          return 'px-data-grid-header-cell';
        }

        static get properties() {
          return {
            /**
             * If true, opens nested dropdown.
             */
            dropdownOpened: {
              type: Boolean,
              observer: '_dropdownOpenedChanged'
            },

            _dropdownHidden: {
              type: Boolean,
              value: true
            },

            _mouseover: {
              type: Boolean,
              value: false
            },

            _column: {
              type: Object
            },

            _dropdownItems: {
              type: Array
            },

            language: String,

            resources: Object

          };
        }

        static get observers() {
          return [
            '_setDropdownItems(language, resources)'
          ];
        }

        ready() {
          super.ready();

          this.addEventListener('mouseenter', () => {
            this._dropdownHidden = false;
            this._mouseover = true;
          });

          this.addEventListener('mouseleave', () => {
            this._mouseover = false;
            if (!this.dropdownOpened) {
              this._dropdownHidden = true;
            }
          });
        }

        _pinColumn() {
          this._column.frozen = true;

          this._setDropdownItems();
        }

        _unpinColumn() {
          this._column.frozen = false;

          this._setDropdownItems();
        }

        _hideColumn() {
          this._column.hidden = true;
        }

        _setDropdownItems() {
          if (this._column && this._column.frozen) {
            this._dropdownItems = [
              {
                key: {
                  action: () => this._unpinColumn()
                },
                val: this.localize('Unpin column')
              },
              {
                key: {
                  action: () => this._hideColumn()
                },
                val: this.localize('Hide column')
              }
            ];
          } else {
            this._dropdownItems = [
              {
                key: {
                  action: () => this._pinColumn()
                },
                val: this.localize('Pin column')
              },
              {
                key: {
                  action: () => this._hideColumn()
                },
                val: this.localize('Hide column')
              }
            ];
          }
        }

        _dropdownOpenedChanged(dropdownOpened) {
          if (!dropdownOpened && !this._mouseover) {
            this._dropdownHidden = true;
          }
        }

        _dropdownSelectedChanged(e) {
          if (e.detail.value) {
            e.detail.value.action();
            e.target.selected = null;
          }
        }

      }

      customElements.define(DataGridHeaderCellElement.is, DataGridHeaderCellElement);

      /**
       * @namespace Predix
       */
      window.Predix = window.Predix || {};
      Predix.DataGridHeaderCellElement = DataGridHeaderCellElement;
    }
  </script>
</dom-module>
